<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R2 å›¾åºŠç®¡ç†</title>
  <style>
    :root {
      --background-image: url('{{BACKGROUND_IMAGE}}');
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: #f5f5f5;
      background-image: var(--background-image);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height: 100vh;
    }
    
    /* ä¸ºé¡µé¢å†…å®¹æ·»åŠ åŠé€æ˜èƒŒæ™¯ï¼Œç¡®ä¿å†…å®¹å¯è¯» */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.85);
      z-index: -1;
    }
    
    /* ç™»å½•é¡µé¢ */
    #loginPage { display: flex; align-items: center; justify-content: center; height: 100vh; position: relative; z-index: 1; }
    .login-box { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 40px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); width: 320px; }
    .login-box h1 { margin-bottom: 24px; color: #333; font-size: 24px; text-align: center; }
    .login-box input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 16px; font-size: 14px; background: rgba(255, 255, 255, 0.9); }
    .login-box button { width: 100%; padding: 12px; background: #0066ff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .login-box button:hover { background: #0052cc; }
    
    /* ä¸»ç•Œé¢ */
    #mainPage { display: none; position: relative; z-index: 1; }
    .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 20px 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 20px; color: #333; }
    .logout-btn { padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; }
    
    .container { max-width: 1400px; margin: 40px auto; padding: 0 40px; }
    
    .breadcrumb { margin-bottom: 20px; font-size: 14px; color: #666; background: rgba(255, 255, 255, 0.9); padding: 12px 16px; border-radius: 8px; }
    .breadcrumb a { color: #0066ff; text-decoration: none; cursor: pointer; }
    .breadcrumb a:hover { text-decoration: underline; }
    
    .toolbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .toolbar input[type="file"] { flex: 1; }
    .toolbar button { padding: 10px 20px; background: #0066ff; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .toolbar button:hover { background: #0052cc; }
    
    .folders { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; margin-bottom: 30px; }
    .folder-item { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .folder-item:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.15); transform: translateY(-2px); }
    .folder-icon { font-size: 48px; margin-bottom: 8px; }
    .folder-name { font-size: 14px; color: #333; word-break: break-all; }
    
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .image-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.2s; }
    .image-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.15); transform: translateY(-2px); }
    .image-card img { width: 100%; height: 200px; object-fit: cover; cursor: pointer; }
    .image-info { padding: 12px; }
    .image-name { font-size: 14px; color: #333; margin-bottom: 8px; word-break: break-all; }
    .image-actions { display: flex; gap: 8px; }
    .image-actions button { flex: 1; padding: 6px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-download { background: #0066ff; color: white; }
    .btn-delete { background: #ff4444; color: white; }
    .btn-copy { background: #28a745; color: white; }
    
    .empty { text-align: center; padding: 60px; color: #666; font-size: 14px; background: rgba(255, 255, 255, 0.9); border-radius: 8px; }
    
    .loading { text-align: center; padding: 40px; color: #666; background: rgba(255, 255, 255, 0.9); border-radius: 8px; }
  </style>
</head>
<body>
  <!-- ç™»å½•é¡µé¢ -->
  <div id="loginPage">
    <div class="login-box">
      <h1>ğŸ” å›¾åºŠç™»å½•</h1>
      <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥å¯†ç " />
      <button onclick="login()">ç™»å½•</button>
    </div>
  </div>

  <!-- ä¸»é¡µé¢ -->
  <div id="mainPage">
    <div class="header">
      <h1>ğŸ“· R2 å›¾åºŠç®¡ç†</h1>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
    
    <div class="container">
      <div class="breadcrumb" id="breadcrumb"></div>
      
      <div class="toolbar">
        <input type="file" id="fileInput" accept="image/*" multiple />
        <button onclick="uploadFiles()">ä¸Šä¼ å›¾ç‰‡</button>
      </div>
      
      <div id="foldersContainer"></div>
      <div id="galleryContainer"></div>
    </div>
  </div>

  <script>
    let currentPath = '';
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkAuth() {
      const authToken = document.cookie.match(/auth_token=([^;]+)/)?.[1];
      if (authToken) {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainPage').style.display = 'block';
        loadImages();
      }
    }
    
    // ç™»å½•
    async function login() {
      const password = document.getElementById('passwordInput').value;
      document.cookie = `auth_token=${password}; path=/; max-age=86400`;
      checkAuth();
    }
    
    // é€€å‡ºç™»å½•
    function logout() {
      document.cookie = 'auth_token=; path=/; max-age=0';
      location.reload();
    }
    
    // åŠ è½½å›¾ç‰‡åˆ—è¡¨
    async function loadImages(path = '') {
      currentPath = path;
      document.getElementById('galleryContainer').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      document.getElementById('foldersContainer').innerHTML = '';
      
      try {
        const response = await fetch(`/api/list?prefix=${encodeURIComponent(path)}`);
        const data = await response.json();
        
        // æ›´æ–°é¢åŒ…å±‘
        updateBreadcrumb(path);
        
        // æ˜¾ç¤ºæ–‡ä»¶å¤¹
        if (data.folders && data.folders.length > 0) {
          const foldersHtml = data.folders.map(folder => {
            const folderName = folder.replace(path, '').replace(/\/$/, '');
            return `
              <div class="folder-item" onclick="loadImages('${folder}')">
                <div class="folder-icon">ğŸ“</div>
                <div class="folder-name">${folderName}</div>
              </div>
            `;
          }).join('');
          document.getElementById('foldersContainer').innerHTML = `<div class="folders">${foldersHtml}</div>`;
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡
        if (data.files && data.files.length > 0) {
          const galleryHtml = data.files.map(file => `
            <div class="image-card">
              <img src="${file.url}" alt="${file.name}" onclick="window.open('${file.url}', '_blank')" />
              <div class="image-info">
                <div class="image-name">${file.name}</div>
                <div class="image-actions">
                  <button class="btn-copy" onclick="copyUrl('${file.url}')">å¤åˆ¶é“¾æ¥</button>
                  <button class="btn-download" onclick="window.open('${file.url}', '_blank')">æŸ¥çœ‹</button>
                  <button class="btn-delete" onclick="deleteImage('${file.key}')">åˆ é™¤</button>
                </div>
              </div>
            </div>
          `).join('');
          document.getElementById('galleryContainer').innerHTML = `<div class="gallery">${galleryHtml}</div>`;
        } else if (!data.folders || data.folders.length === 0) {
          document.getElementById('galleryContainer').innerHTML = '<div class="empty">æš‚æ— å›¾ç‰‡</div>';
        } else {
          document.getElementById('galleryContainer').innerHTML = '';
        }
      } catch (error) {
        document.getElementById('galleryContainer').innerHTML = `<div class="empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
    function updateBreadcrumb(path) {
      const parts = path.split('/').filter(p => p);
      let breadcrumbHtml = '<a onclick="loadImages(\'\')">é¦–é¡µ</a>';
      let accumulatedPath = '';
      
      parts.forEach((part, index) => {
        accumulatedPath += part + '/';
        breadcrumbHtml += ` / <a onclick="loadImages('${accumulatedPath}')">${part}</a>`;
      });
      
      document.getElementById('breadcrumb').innerHTML = breadcrumbHtml;
    }
    
    // ä¸Šä¼ æ–‡ä»¶
    async function uploadFiles() {
      const files = document.getElementById('fileInput').files;
      if (files.length === 0) {
        alert('è¯·é€‰æ‹©æ–‡ä»¶');
        return;
      }
      
      for (const file of files) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('path', currentPath);
        
        try {
          const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          if (result.success) {
            console.log(`ä¸Šä¼ æˆåŠŸ: ${file.name}`);
          } else {
            alert(`ä¸Šä¼ å¤±è´¥: ${result.error}`);
          }
        } catch (error) {
          alert(`ä¸Šä¼ å¤±è´¥: ${error.message}`);
        }
      }
      
      // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å¹¶åˆ·æ–°åˆ—è¡¨
      document.getElementById('fileInput').value = '';
      loadImages(currentPath);
    }
    
    // åˆ é™¤å›¾ç‰‡
    async function deleteImage(key) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—?')) return;
      
      try {
        const response = await fetch('/api/delete', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key })
        });
        
        const result = await response.json();
        if (result.success) {
          loadImages(currentPath);
        } else {
          alert(`åˆ é™¤å¤±è´¥: ${result.error}`);
        }
      } catch (error) {
        alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
      }
    }
    
    // å¤åˆ¶URL
    function copyUrl(url) {
      navigator.clipboard.writeText(url).then(() => {
        alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      });
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    checkAuth();
  </script>
</body>
</html>
